name: Automated Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y exim4 python3 python3-pip

      - name: Configure Exim4
        run: |
          echo "dc_eximconfig_configtype=internet" | sudo tee /etc/exim4/update-exim4.conf.conf
          echo "dc_other_hostnames=" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_local_interfaces=127.0.0.1" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_readhost=" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_relay_domains=" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_minimaldns=false" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_relay_nets=" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_smarthost=" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "CFILEMODE=644" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_use_split_config=true" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_hide_mailname=true" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          echo "dc_mailname=localhost" | sudo tee -a /etc/exim4/update-exim4.conf.conf
          sudo update-exim4.conf
          sudo systemctl restart exim4

      - name: Install Python packages
        run: |
          python3 -m pip install --upgrade pip
          pip3 install telethon

      - name: Run Telegram ingestion
        run: python3 t.py

      - name: Process data
        run: python3 data.py

      - name: Shuffle list
        run: shuf all.txt -o all.txt

      - name: Execute pipeline
        run: |
          chmod +x send.sh
          ./send.sh
